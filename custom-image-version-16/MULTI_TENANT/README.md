
# ğŸš€ Frappe HRMS v16 â€“ Multi-Tenant Setup (Docker + Traefik)

> **Audience**: Engineers setting up Frappe / ERPNext / HRMS v16  
> **Goal**:
> - Build a **custom Frappe HRMS v16 image**
> - Deploy a **first site normally**
> - Convert setup to **DNS-based multitenancy**
> - Add a **second site**
> - Enable **scheduler**
> - Keep the setup reproducible and production-correct

---

## ğŸ§¹ 0. Clean Slate (Intentional Full Reset)

âš ï¸ **Only do this on a fresh server or when you intentionally want to wipe everything**

```bash
docker compose -f frappe-hrms-compose.yml down -v
docker ps -aq | xargs -r docker rm -f
docker images -q | xargs -r docker rmi -f
docker system prune -a --volumes
````

Remove old setup files:

```bash
rm -rf \
  easy-install.log \
  easy-install.py \
  frappe_docker/ \
  frappe-hrms-compose.yml \
  frappe-hrms.env \
  frappe-hrms-passwords.txt
```

---

## ğŸ“¥ 1. Download Custom `easy-install.py`

```bash
wget https://raw.githubusercontent.com/frappe/bench/develop/easy-install.py
```

Replace it **entirely** with your custom version:

```bash
nano easy-install.py
```

### ğŸ”§ Custom defaults baked into this file

* Frappe repo â†’ `https://github.com/Yaswanth-Vempuluru-7916/frappe`
* Frappe branch â†’ `version-16`
* Python â†’ `3.14`
* Node â†’ `24.1.0`

---

## ğŸ” Why `easy-install.py build` Is Run **Twice**

This is **intentional** and **not redundant**.

### ğŸ§  What `build` actually does

1. Clones the `frappe_docker` repository
2. Builds & pushes a Docker image using:

```
frappe_docker/images/custom/Containerfile
```

### â— The key constraint

ğŸ‘‰ `frappe_docker/` **does not exist before the first build**

So you **cannot edit**:

```
frappe_docker/images/custom/Containerfile
```

until **after** the first build.

---

### ğŸ”¹ Build #1 â€” Bootstrap Build

```bash
python3 easy-install.py build \
  --apps-json apps.json \
  --containerfile images/custom/Containerfile \
  --tag yaswanth1679/frappe-hrms:version-16 \
  --push
```

Purpose:

* Create `frappe_docker/`
* Generate `images/custom/Containerfile`

Result:

* Image is built with **default ARG values**
* Image is **disposable**

> ğŸ” If this is your first push:

```bash
docker login
```

---

### ğŸ”¹ Edit Containerfile (Critical Step)

Now that `frappe_docker/` exists:

```bash
nano frappe_docker/images/custom/Containerfile
```

Update:

```dockerfile
ARG PYTHON_VERSION=3.14
ARG NODE_VERSION=24.1.0
```

Why this matters:

* These ARGs **control the runtime**
* `easy-install.py` defaults alone are **not enough**

---

### ğŸ”¹ Build #2 â€” Final Production Image

```bash
python3 easy-install.py build \
  --apps-json apps.json \
  --containerfile images/custom/Containerfile \
  --tag yaswanth1679/frappe-hrms:version-16 \
  --push
```

Purpose:

* Rebuild image with **correct Python & Node**
* Push **final production image**

âœ… This is the image used in deployment.

---

## ğŸ” Why `easy-install.py deploy` Runs Twice

Again â€” **intentional and expected**.

---

## ğŸš« Deploy #1 â€” Expected to Fail (Bootstrap Deploy)

```bash
python3 easy-install.py deploy \
  --project frappe-hrms \
  --sitename uat-pwv2.hashiraworks.com \
  --email yaswanthvempuluru@gmail.com \
  --image yaswanth1679/frappe-hrms:version-16 \
  --app erpnext \
  --app hrms
```

### Why run this even though it fails?

Because it **generates critical files**:

* `frappe-hrms.env`
* `frappe-hrms-compose.yml`
* `frappe-hrms-passwords.txt`

These files **do not exist before the first deploy**.

---

### Why this deploy fails (and thatâ€™s OK)

The autogenerated `.env` contains:

```env
ERPNEXT_VERSION=v15.94.3
CUSTOM_IMAGE=yaswanth1679/frappe-hrms:version-16
```

Docker resolves this as:

```
yaswanth1679/frappe-hrms:version-16:v15.94.3
```

âŒ Invalid image reference â†’ deploy fails
âœ… Failure is **expected and harmless**

---

## âš™ï¸ Fix Environment Configuration (Using `sed`)

Edit is **scripted and reproducible** â€” no manual mistakes.

### âŒ Remove ERPNext version

```bash
sed -i '/^ERPNEXT_VERSION=/d' frappe-hrms.env
```

### ğŸ” Fix image reference

```bash
sed -i 's|CUSTOM_IMAGE=yaswanth1679/frappe-hrms:version-16|CUSTOM_IMAGE=yaswanth1679/frappe-hrms|' frappe-hrms.env
echo "CUSTOM_TAG=version-16" >> frappe-hrms.env
```

### ğŸ” Verify

```bash
cat frappe-hrms.env
```

Expected critical lines:

```env
CUSTOM_IMAGE=yaswanth1679/frappe-hrms
CUSTOM_TAG=version-16
```

New update : 

```bash
export SITES_RULE='Host(`pw-uatv2.lykkeworks.com`)'
```

---

## âœ… Deploy #2 â€” Real Deployment

```bash
python3 easy-install.py deploy \
  --project frappe-hrms \
  --sitename uat-pwv2.hashiraworks.com \
  --email yaswanthvempuluru@gmail.com \
  --image yaswanth1679/frappe-hrms:version-16 \
  --app erpnext \
  --app hrms
```

Result:

* Containers start correctly
* First site is created
* ERPNext + HRMS installed

---

## ğŸŒ First Site UI Setup

Open in browser:

```
https://uat-pwv2.hashiraworks.com
```

âœ” Complete initial UI setup
âœ” Verify everything works

---

## ğŸ›‘ Stop Containers (âš ï¸ DO NOT DELETE VOLUMES)

```bash
docker compose -f frappe-hrms-compose.yml down
```

âŒ **Never use `-v` here**

---

## ğŸŒ Enable DNS-Based Multitenancy (Traefik)

Edit compose file:

```bash
nano frappe-hrms-compose.yml
```

Change Traefik rule:

```diff
- traefik.http.routers.frontend-http.rule: Host(`uat-pwv2.hashiraworks.com`)
+ traefik.http.routers.frontend-http.rule: HostRegexp(`{host:.+}`)
```

---

## â–¶ï¸ Start Containers Again

```bash
docker compose -f frappe-hrms-compose.yml up -d
```

---

## ğŸ§  Enable DNS Multitenancy in Frappe

```bash
docker exec -it frappe-hrms-backend-1 bash
bench config dns_multitenant on
cat sites/common_site_config.json
```

Expected:

```json
"dns_multitenant": true
```

---

## â• Create Second Site (Important Prompts Explained)

```bash
bench new-site uat-gvsv2.hashiraworks.com
```

When prompted:

* **Enter mysql super user [root]:**
  ğŸ‘‰ Just press **Enter**

* **MySQL root password:**
  ğŸ‘‰ Enter the value of `DB_PASSWORD` from `frappe-hrms.env`

* **Site Administrator password:**
  ğŸ‘‰ Enter **any temporary password**
  (You will later use the **same admin password as the first site**, and can change it from UI)

Then install apps:

```bash
bench --site uat-gvsv2.hashiraworks.com install-app erpnext
bench --site uat-gvsv2.hashiraworks.com install-app hrms
```

---

## â±ï¸ Enable Scheduler (Per Site)

```bash
bench --site uat-pwv2.hashiraworks.com enable-scheduler
bench --site uat-gvsv2.hashiraworks.com enable-scheduler
```

Verify:

```bash
bench --site uat-pwv2.hashiraworks.com doctor
bench --site uat-gvsv2.hashiraworks.com doctor
```

---

## ğŸ§  Mental Model (Remember This)

| Step               | Purpose                          |
| ------------------ | -------------------------------- |
| Build #1           | Create `frappe_docker/`          |
| Edit Containerfile | Fix Python & Node                |
| Build #2           | Final production image           |
| Deploy #1          | Generate configs (expected fail) |
| Fix `.env`         | Correct image reference          |
| Deploy #2          | Real deployment                  |

---

## âš ï¸ Golden Rule

> **Containers are disposable. Volumes are your ERP.**

* âœ… `docker compose down` â†’ Safe
* âŒ `docker compose down -v` â†’ Deletes ERP data

---

## ğŸ Final Outcome

* âœ… Custom HRMS v16 image
* âœ… HTTPS + Traefik
* âœ… DNS-based multitenancy
* âœ… Multiple isolated sites
* âœ… Separate databases per site
* âœ… Scheduler running

